      

      
        
                  <div class="label">7-Day Average</div>
                  <div class="value" id="summary7Day">0</div>
                </div>
                <div class="summary-stat">
                  <div class="label">Monthly Total</div>
                  <div class="value" id="summaryMonthly">0</div>
                </div>
                <div class="summary-stat">
                  <div class="label">Active Days</div>
                  <div class="value" id="summaryActiveDays">0</div>
                </div>
                <div class="summary-stat">
                  <div class="label">Streak Days</div>
                  <div class="value" id="summaryStreak">0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Detailed History Tab -->
          <div
            class="history-section"
            id="historyDetailedTab"
            style="display: none"
          >
            <div class="filter-chips">
              <div class="filter-chip active" onclick="filterHistory('all')">
                All Days
              </div>
              <div class="filter-chip" onclick="filterHistory('high')">
                High Count (>50)
              </div>
              <div class="filter-chip" onclick="filterHistory('completed')">
                Completed Rounds
              </div>
              <div class="filter-chip" onclick="filterHistory('recent')">
                Last 7 Days
              </div>
              <div class="filter-chip" onclick="filterHistory('month')">
                This Month
              </div>
            </div>

            <div class="history-list" id="historyList">
              <!-- History items will be dynamically added here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let counters = [];
      let currentCounter = null;
      let currentView = "home";
      let currentHistoryTab = "summary";
      let currentFilter = "all";
      let currentSort = "date";
      let isDescending = true;
      let currentThemeColor = "#ff4500"; // Default orange theme

      // Counter-specific variables
      let count = 0;
      let dailyCount = 0;
      let lifetimeCount = 0;
      let japTarget = 108;
      let vibrationOn = true;

      // Initialize app with mobile optimizations
      window.addEventListener("load", function () {
        // Start mala formation animation
        startMalaAnimation();

        loadCounters();
        checkDailyReset(); // Check this before loading counter data
        loadThemeColor(); // Load saved theme color
        loadSavedWallpaper(); // Load saved wallpaper
        if (counters.length > 0) {
          showHomeScreen();
        }
        initializeEditButton();
        initializeMobileOptimizations();
      });

      function startMalaAnimation() {
        const beads = document.querySelectorAll(".mala-bead");
        let currentBead = 0;

        function showNextBead() {
          if (currentBead < beads.length) {
            playTukSound();
            beads[currentBead].classList.add("show");
            currentBead++;
            setTimeout(showNextBead, 100);
          } else {
            setTimeout(() => {
              const tassel = document.getElementById("malaTassel");
              if (tassel) {
                tassel.style.opacity = "1";
                tassel.style.animation = "appearTassel 0.5s ease-out forwards";
                playCompletionSound();
                setTimeout(() => {
                  hideOpeningAnimation();
                }, 1500);
              }
            }, 300);
          }
        }

        setTimeout(showNextBead, 500);
      }

      function playTukSound() {
        // Create audio context for more realistic tuk sound
        try {
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();

          // Create multiple oscillators for richer sound
          const oscillator1 = audioContext.createOscillator();
          const oscillator2 = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          const filter = audioContext.createBiquadFilter();

          // Configure filter for wooden bead sound
          filter.type = "lowpass";
          filter.frequency.setValueAtTime(1200, audioContext.currentTime);
          filter.Q.setValueAtTime(2, audioContext.currentTime);

          // Connect audio nodes
          oscillator1.connect(filter);
          oscillator2.connect(filter);
          filter.connect(gainNode);
          gainNode.connect(audioContext.destination);

          // Set frequencies for wood-like tuk sound
          oscillator1.frequency.setValueAtTime(900, audioContext.currentTime);
          oscillator1.frequency.exponentialRampToValueAtTime(
            300,
            audioContext.currentTime + 0.08
          );

          oscillator2.frequency.setValueAtTime(1400, audioContext.currentTime);
          oscillator2.frequency.exponentialRampToValueAtTime(
            500,
            audioContext.currentTime + 0.06
          );

          // Shape the sound envelope
          gainNode.gain.setValueAtTime(0, audioContext.currentTime);
          gainNode.gain.linearRampToValueAtTime(
            0.15,
            audioContext.currentTime + 0.01
          );
          gainNode.gain.exponentialRampToValueAtTime(
            0.001,
            audioContext.currentTime + 0.1
          );

          // Use square wave for sharper attack
          oscillator1.type = "square";
          oscillator2.type = "triangle";

          oscillator1.start(audioContext.currentTime);
          oscillator1.stop(audioContext.currentTime + 0.1);
          oscillator2.start(audioContext.currentTime);
          oscillator2.stop(audioContext.currentTime + 0.08);
        } catch (e) {
          // Fallback for browsers without audio context
          console.log("🔊 Tuk!");
        }
      }

      function playCompletionSound() {
        // Create audio context for completion chime
        try {
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillator.frequency.setValueAtTime(523, audioContext.currentTime); // C5
          oscillator.frequency.setValueAtTime(
            659,
            audioContext.currentTime + 0.2
          ); // E5
          oscillator.frequency.setValueAtTime(
            784,
            audioContext.currentTime + 0.4
          ); // G5

          gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(
            0.01,
            audioContext.currentTime + 0.6
          );

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.6);
        } catch (e) {
          // Fallback for browsers without audio context
          console.log("Completion chime");
        }
      }

      function hideOpeningAnimation() {
        const animation = document.getElementById("openingAnimation");
        if (animation) {
          animation.classList.add("hide");
          setTimeout(() => {
            animation.style.display = "none";
          }, 800);
        }
      }

      // Mobile-specific optimizations
      function initializeMobileOptimizations() {
        // Prevent zoom on double tap for iOS
        let lastTouchEnd = 0;
        document.addEventListener(
          "touchend",
          function (event) {
            const now = new Date().getTime();
            if (now - lastTouchEnd <= 300) {
              event.preventDefault();
            }
            lastTouchEnd = now;
          },
          false
        );

        // Improve touch response for main counter buttons
        const tapBtn = document.querySelector(".tap-btn");
        const sideBtns = document.querySelectorAll(".side-btn");

        if (tapBtn) {
          tapBtn.addEventListener(
            "touchstart",
            function (e) {
              e.preventDefault();
              this.style.transform = "scale(0.95)";
            },
            { passive: false }
          );

          tapBtn.addEventListener(
            "touchend",
            function (e) {
              e.preventDefault();
              this.style.transform = "scale(1)";
              increment();
            },
            { passive: false }
          );
        }

        sideBtns.forEach((btn) => {
          btn.addEventListener(
            "touchstart",
            function (e) {
              e.preventDefault();
              this.style.transform = "scale(0.9)";
            },
            { passive: false }
          );

          btn.addEventListener(
            "touchend",
            function (e) {
              e.preventDefault();
              this.style.transform = "scale(1)";
              decrement();
            },
            { passive: false }
          );
        });

        // Enhance counter card touch response
        const counterCards = document.querySelectorAll(".counter-card");
        counterCards.forEach((card) => {
          card.addEventListener("touchstart", function (e) {
            this.style.transform = "translateY(-2px) scale(0.98)";
          });

          card.addEventListener("touchend", function (e) {
            this.style.transform = "translateY(0) scale(1)";
          });
        });

        // Optimize modal close for mobile
        const overlay = document.getElementById("overlay");
        if (overlay) {
          overlay.addEventListener("touchstart", function (e) {
            if (e.target === this) {
              closeSettings();
              closeHistory();
            }
          });
        }

        // Prevent scroll on modal content
        const modals = document.querySelectorAll(
          ".settings-modal, .history-modal"
        );
        modals.forEach((modal) => {
          modal.addEventListener("touchmove", function (e) {
            e.stopPropagation();
          });
        });
      }

      // Date management functions
      function checkDailyReset() {
        const today = new Date().toDateString();
        const lastActiveDate = localStorage.getItem("lastActiveDate");

        if (lastActiveDate && lastActiveDate !== today) {
          // New day detected - save yesterday's data for all counters
          counters.forEach((counter) => {
            if (counter.todayCount && counter.todayCount > 0) {
              if (!counter.dailyHistory) {
                counter.dailyHistory = {};
              }
              counter.dailyHistory[lastActiveDate] = counter.todayCount;
              counter.todayCount = 0; // Reset daily count for new day
              counter.currentCount = 0; // Reset current session count
            }
          });
          saveCounters();
        }

        localStorage.setItem("lastActiveDate", today);
      }

      function saveDailyHistory(date, count) {
        if (!currentCounter) return;

        if (!currentCounter.dailyHistory) {
          currentCounter.dailyHistory = {};
        }

        if (count > 0) {
          currentCounter.dailyHistory[date] = count;
          saveCounters();
        }
      }

      function saveCurrentDayHistory() {
        if (!currentCounter) return;

        const today = new Date().toDateString();
        if (dailyCount > 0) {
          if (!currentCounter.dailyHistory) {
            currentCounter.dailyHistory = {};
          }
          currentCounter.dailyHistory[today] = dailyCount;
        }
      }

      function getCurrentDayHistory() {
        if (!currentCounter || !currentCounter.dailyHistory) return {};
        return currentCounter.dailyHistory;
      }

      function formatDateForDisplay(dateString) {
        const date = new Date(dateString);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        // Normalize dates to remove time component
        const dateOnly = new Date(
          date.getFullYear(),
          date.getMonth(),
          date.getDate()
        );
        const todayOnly = new Date(
          today.getFullYear(),
          today.getMonth(),
          today.getDate()
        );
        const yesterdayOnly = new Date(
          yesterday.getFullYear(),
          yesterday.getMonth(),
          yesterday.getDate()
        );

        if (dateOnly.getTime() === todayOnly.getTime()) {
          return "Today";
        } else if (dateOnly.getTime() === yesterdayOnly.getTime()) {
          return "Yesterday";
        } else {
          // Always show year for clarity
          return date.toLocaleDateString("en-US", {
            weekday: "short",
            month: "short",
            day: "numeric",
            year: "numeric",
          });
        }
      }

      function getDayOfWeek(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-US", {
          weekday: "long",
          month: "short",
          day: "numeric",
        });
      }

      // View management
      function showView(viewName) {
        // Hide all views
        document.querySelectorAll(".view").forEach((view) => {
          view.classList.remove("active");
        });

        // Show selected view
        document.getElementById(viewName + "View").classList.add("active");
        currentView = viewName;
      }

      // HOME FUNCTIONS
      function loadCounters() {
        try {
          const saved = localStorage.getItem("japCounters");
          if (saved) {
            counters = JSON.parse(saved);
            // Migrate old data structure if needed
            counters.forEach((counter) => {
              if (!counter.dailyHistory) {
                counter.dailyHistory = {};
              }
            });
          }
        } catch (e) {
          console.warn("Could not load counters from localStorage");
          counters = [];
        }
      }

      function saveCounters() {
        try {
          localStorage.setItem("japCounters", JSON.stringify(counters));
        } catch (e) {
          console.warn("Could not save counters to localStorage");
        }
      }

      function generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2);
      }

      function formatDate(date) {
        const options = { day: "numeric", month: "short", year: "numeric" };
        return date.toLocaleDateString("en-GB", options);
      }

      function createCounter(name) {
        return {
          id: generateId(),
          name: name.trim(),
          createdDate: new Date(),
          lastUpdated: new Date(),
          todayCount: 0,
          lifetimeCount: 0,
          currentCount: 0,
          target: 108,
          mantra: "ॐ नमः शिवाय",
          dailyHistory: {},
        };
      }

      function showHomeScreen() {
        document.getElementById("welcomeScreen").style.display = "none";
        document.getElementById("homeScreen").style.display = "flex";
        renderCounters();
      }

      function showWelcomeScreen() {
        document.getElementById("homeScreen").style.display = "none";
        document.getElementById("welcomeScreen").style.display = "flex";
      }

      function renderCounters() {
        const grid = document.getElementById("countersGrid");
        grid.innerHTML = "";

        counters.forEach((counter, index) => {
          const todayRounds = Math.floor(counter.todayCount / counter.target);
          const lifetimeRounds = Math.floor(
            counter.lifetimeCount / counter.target
          );

          const card = document.createElement("div");
          card.className = "counter-card loading";
          card.innerHTML = `
<div class="card-header">
<div class="counter-name-display">
<div class="counter-icon"></div>
<span class="counter-name">${counter.name}</span>
</div>
<span class="counter-date">${formatDate(new Date(counter.lastUpdated))}</span>
</div>
<div class="card-stats">
<div class="stat-section">
<div class="stat-label">Today</div>
<div class="stat-value">${counter.todayCount}</div>
<div class="stat-secondary">Lifetime</div>
<div class="stat-value" style="font-size: 20px; margin-top: 4px;">${
            counter.lifetimeCount
          }</div>
</div>
<div class="stat-section stat-rounds">
<div class="rounds-label">108 ×</div>
<div class="rounds-value">${todayRounds}</div>
<div class="rounds-label" style="margin-top: 8px;">108 ×</div>
<div class="rounds-value" style="font-size: 18px;">${lifetimeRounds}</div>
</div>
</div>
`;

          // Add click handler to open counter
          card.addEventListener("click", function (e) {
            openCounter(counter.id);
          });

          // Add long press handler to delete counter
          let longPressTimer;
          card.addEventListener("touchstart", function (e) {
            longPressTimer = setTimeout(() => {
              deleteCounter(counter.id);
            }, 800); // 800ms long press
          });

          card.addEventListener("touchend", function (e) {
            clearTimeout(longPressTimer);
          });

          card.addEventListener("touchmove", function (e) {
            clearTimeout(longPressTimer);
          });

          // For desktop - mousedown/mouseup
          card.addEventListener("mousedown", function (e) {
            longPressTimer = setTimeout(() => {
              deleteCounter(counter.id);
            }, 800);
          });

          card.addEventListener("mouseup", function (e) {
            clearTimeout(longPressTimer);
          });

          card.addEventListener("mouseleave", function (e) {
            clearTimeout(longPressTimer);
          });

          grid.appendChild(card);

          setTimeout(() => {
            card.classList.remove("loading");
            card.classList.add("loaded");
          }, index * 100);
        });
      }

      function deleteCounter(counterId) {
        if (confirm("Delete this counter? This action cannot be undone.")) {
          counters = counters.filter((c) => c.id !== counterId);
          saveCounters();
          if (counters.length === 0) {
            showWelcomeScreen();
          } else {
            renderCounters();
          }
        }
      }

      function openCounter(counterId) {
        const counter = counters.find((c) => c.id === counterId);
        if (counter) {
          currentCounter = counter;
          loadCounterData(counter);
          showView("counter");
        }
      }

      // COUNTER FUNCTIONS
      function loadCounterData(counter) {
        count = counter.currentCount || 0;
        dailyCount = counter.todayCount || 0;
        lifetimeCount = counter.lifetimeCount || 0;
        japTarget = counter.target || 108;

        // Set counter name as the current mantra
        const mantraElement = document.getElementById("currentMantraBottom");
        if (mantraElement && counter.name) {
          mantraElement.textContent = counter.name;
        }

        const headerTitle = document.getElementById("counterTitle");
        if (headerTitle) {
          headerTitle.innerHTML = ` Jap Counter`;
        }

        const settingsCounterName = document.getElementById(
          "settingsCounterName"
        );
        if (settingsCounterName) {
          settingsCounterName.textContent = counter.name;
        }

        const settingsTarget = document.getElementById("settingsTarget");
        if (settingsTarget) {
          settingsTarget.textContent = counter.target;
        }

        updateDisplay();
      }

      function saveCounterData() {
        if (currentCounter) {
          // Save today's count to daily history
          const today = new Date().toDateString();
          if (!currentCounter.dailyHistory) {
            currentCounter.dailyHistory = {};
          }

          // Always save today's count, even if zero (for accurate tracking)
          if (dailyCount >= 0) {
            currentCounter.dailyHistory[today] = dailyCount;
          }

          currentCounter.currentCount = count;
          currentCounter.todayCount = dailyCount;
          currentCounter.lifetimeCount = lifetimeCount;
          currentCounter.target = japTarget;
          currentCounter.lastUpdated = new Date();

          const counterIndex = counters.findIndex(
            (c) => c.id === currentCounter.id
          );
          if (counterIndex !== -1) {
            counters[counterIndex] = currentCounter;
            saveCounters();
          }
        }
      }

      function updateDisplay() {
        document.getElementById("count").innerText = count + " / " + japTarget;
        document.getElementById("today").innerText = dailyCount;
        document.getElementById("todayRounds").innerText = Math.floor(
          dailyCount / japTarget
        );
        document.getElementById("lifetime").innerText = lifetimeCount;
        document.getElementById("lifetimeRounds").innerText = Math.floor(
          lifetimeCount / japTarget
        );
      }

      function increment() {
        count++;
        dailyCount++;
        lifetimeCount++;

        updateDisplay();
        saveCounterData();

        if (vibrationOn && navigator.vibrate) {
          navigator.vibrate(100);
        }

        if (count >= japTarget) {
          alert("One Mala Completed 🙏");
          count = 0;
          updateDisplay();
          saveCounterData();
        }
      }

      function decrement() {
        if (count > 0) {
          count--;
          dailyCount = Math.max(0, dailyCount - 1);
          lifetimeCount = Math.max(0, lifetimeCount - 1);

          updateDisplay();
          saveCounterData();

          if (vibrationOn && navigator.vibrate) {
            navigator.vibrate(100);
          }
        }
      }

      function resetAll() {
        if (confirm("Are you sure you want to reset all counts?")) {
          count = 0;
          dailyCount = 0;
          lifetimeCount = 0;
          updateDisplay();
          saveCounterData();
        }
      }

      function setJapCount() {
        let newCount = prompt(
          "Enter Jap target (e.g., 108, 54, 27):",
          japTarget
        );
        if (newCount && !isNaN(newCount) && newCount > 0) {
          japTarget = parseInt(newCount);
          count = 0;
          updateDisplay();
          saveCounterData();

          const settingsTarget = document.getElementById("settingsTarget");
          if (settingsTarget) {
            settingsTarget.textContent = japTarget;
          }

          alert("Jap target set to " + japTarget);
        }
      }

      // Deity images data - Traditional temple-style images
      const deities = [
        {
          name: "Lord Ganesha",
          image: "/images/ganesha.jpg",
        },
        {
          name: "Lord Shiva",
          image: "/images/shiva.jpg",
        },
        {
          name: "Goddess Lakshmi",
          image: "/images/lakshmi.jpg",
        },
        {
          name: "Lord Krishna",
          image: "/images/krishna.jpg",
        },
        {
          name: "Goddess Durga",
          image: "/images/durga.jpg",
        },
        {
          name: "Lord Hanuman",
          image: "/images/hanuman.jpg",
        },
        {
          name: "Goddess Saraswati",
          image: "/images/saraswati.jpg",
        },
        {
          name: "Lord Rama",
          image: "/images/rama.jpg",
        },
        {
          name: "Goddess Kali",
          image: "/images/kali.jpg",
        },
        {
          name: "Lord Vishnu",
          image: "/images/vishnu.jpg",
        },
      ];

      let currentDeityForLightbox = null;

      function changeWallpaper() {
        const modal = document.getElementById("wallpaperModal");
        modal.classList.add("show");
        renderWallpaperGallery();
      }

      function closeWallpaperModal() {
        const modal = document.getElementById("wallpaperModal");
        modal.classList.remove("show");
      }

      function renderWallpaperGallery() {
        const grid = document.getElementById("wallpaperGrid");
        grid.innerHTML = "";

        deities.forEach((deity) => {
          const card = document.createElement("div");
          card.className = "wallpaper-card";
          card.onclick = () => openWallpaperLightbox(deity);
          card.innerHTML = `
            <div class="wallpaper-card-image-wrapper">
              <img 
                src="${deity.image}" 
                alt="${deity.name}"
                class="wallpaper-card-image"
                onerror="this.src='https://via.placeholder.com/800/FF4500/FFFFFF?text=${encodeURIComponent(
                  deity.name
                )}'"
              />
            </div>
            <div class="wallpaper-card-overlay"></div>
            <div class="wallpaper-card-title">${deity.name}</div>
          `;
          grid.appendChild(card);
        });
      }

      function openWallpaperLightbox(deity) {
        currentDeityForLightbox = deity;
        const lightbox = document.getElementById("wallpaperLightbox");
        const lightboxImage = document.getElementById("wallpaperLightboxImage");
        const lightboxTitle = document.getElementById("wallpaperLightboxTitle");

        lightboxImage.src = deity.image;
        lightboxImage.alt = deity.name;
        lightboxTitle.textContent = deity.name;

        lightbox.classList.add("active");
        document.body.style.overflow = "hidden";
      }

      function closeWallpaperLightbox(event) {
        if (
          event &&
          (event.target.id === "wallpaperLightbox" ||
            event.target.closest(".wallpaper-lightbox-close"))
        ) {
          const lightbox = document.getElementById("wallpaperLightbox");
          lightbox.classList.remove("active");
          document.body.style.overflow = "auto";
          currentDeityForLightbox = null;
        }
      }

      function setAsWallpaper(event) {
        event.stopPropagation();
        if (!currentDeityForLightbox) return;

        // Set the wallpaper as body background
        document.body.style.backgroundImage = `url('${currentDeityForLightbox.image}')`;

        // Save the wallpaper preference
        localStorage.setItem(
          "selectedWallpaper",
          currentDeityForLightbox.image
        );

        // Close the lightbox and modal
        closeWallpaperLightbox(event);
        closeWallpaperModal();

        // Show confirmation
        alert(`Wallpaper set to ${currentDeityForLightbox.name} 🙏`);
      }

      function downloadWallpaper(event) {
        event.stopPropagation();
        if (!currentDeityForLightbox) return;

        const link = document.createElement("a");
        link.href = currentDeityForLightbox.image;
        link.download = `${currentDeityForLightbox.name.replace(
          /\s+/g,
          "_"
        )}.jpg`;

        fetch(currentDeityForLightbox.image)
          .then((response) => response.blob())
          .then((blob) => {
            const blobUrl = URL.createObjectURL(blob);
            link.href = blobUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(blobUrl);
          })
          .catch(() => {
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });
      }

      function loadSavedWallpaper() {
        const savedWallpaper = localStorage.getItem("selectedWallpaper");
        if (savedWallpaper) {
          document.body.style.backgroundImage = `url('${savedWallpaper}')`;
        }
      }

      function goBackHome() {
        saveCounterData();
        showView("home");
        if (counters.length > 0) {
          showHomeScreen();
        } else {
          showWelcomeScreen();
        }
      }

      function openSettings() {
        document.getElementById("settingsModal").classList.add("show");
        document.getElementById("overlay").classList.add("show");
      }

      function closeSettings() {
        document.getElementById("settingsModal").classList.remove("show");
        document.getElementById("overlay").classList.remove("show");
        // Remove blur effect when closing settings
        document.body.classList.remove("color-picker-active");
      }

      // ENHANCED HISTORY FUNCTIONS
      function openHistory() {
        updateHistorySummary();
        updateHistoryDetailed();
        document.getElementById("historyModal").classList.add("show");
        document.getElementById("overlay").classList.add("show");
      }

      function closeHistory() {
        document.getElementById("historyModal").classList.remove("show");
        document.getElementById("overlay").classList.remove("show");
      }

      function switchHistoryTab(tabName) {
        currentHistoryTab = tabName;

        // Update tab buttons
        document.querySelectorAll(".history-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Show/hide content
        if (tabName === "summary") {
          document.getElementById("historySummaryTab").style.display = "block";
          document.getElementById("historyDetailedTab").style.display = "none";
        } else {
          document.getElementById("historySummaryTab").style.display = "none";
          document.getElementById("historyDetailedTab").style.display = "block";
        }
      }

      function updateHistorySummary() {
        if (!currentCounter) return;

        const history = currentCounter.dailyHistory || {};
        const historyEntries = Object.entries(history);
        const today = new Date().toDateString();

        // Basic stats
        document.getElementById("summaryToday").innerText = dailyCount;
        document.getElementById("summaryTodayRounds").innerText = Math.floor(
          dailyCount / japTarget
        );
        document.getElementById("summaryLifetime").innerText = lifetimeCount;

        // Active days calculation - count all days with count > 0
        const activeDaysFromHistory = historyEntries.filter(
          ([date, count]) => count > 0
        ).length;
        const isTodayActive = dailyCount > 0 ? 1 : 0;
        const activeDays = activeDaysFromHistory + isTodayActive;

        // Calculate 7-day average - get last 7 days including today
        const now = new Date();
        const last7DaysData = [];

        for (let i = 0; i < 7; i++) {
          const checkDate = new Date(now);
          checkDate.setDate(checkDate.getDate() - i);
          const dateStr = checkDate.toDateString();

          if (dateStr === today) {
            last7DaysData.push(dailyCount);
          } else {
            last7DaysData.push(history[dateStr] || 0);
          }
        }

        const avg7Day =
          last7DaysData.length > 0
            ? Math.round(
                last7DaysData.reduce((a, b) => a + b, 0) / last7DaysData.length
              )
            : 0;

        // Find best day - include today's count
        const allCounts = [
          ...historyEntries.map(([date, count]) => count),
          dailyCount,
        ];
        const bestDay = allCounts.length > 0 ? Math.max(...allCounts) : 0;

        // Calculate monthly total - current month only
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        let thisMonth = dailyCount; // Start with today's count

        historyEntries.forEach(([date, count]) => {
          const entryDate = new Date(date);
          if (
            entryDate.getMonth() === currentMonth &&
            entryDate.getFullYear() === currentYear &&
            date !== today
          ) {
            // Don't double count today
            thisMonth += count;
          }
        });

        // Calculate streak - consecutive days with count > 0
        let streak = 0;
        const sortedDates = [...historyEntries]
          .filter(([date, count]) => count > 0)
          .sort(([a], [b]) => new Date(b) - new Date(a));

        // Check if today has activity
        if (dailyCount > 0) {
          streak = 1;

          // Check previous days
          let checkDate = new Date(now);
          for (let i = 1; i <= sortedDates.length; i++) {
            checkDate.setDate(checkDate.getDate() - 1);
            const expectedDate = checkDate.toDateString();

            const found = sortedDates.find(([date]) => date === expectedDate);
            if (found && found[1] > 0) {
              streak++;
            } else {
              break;
            }
          }
        } else {
          // If today has no activity, check if yesterday has activity
          const yesterday = new Date(now);
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toDateString();

          const yesterdayEntry = sortedDates.find(
            ([date]) => date === yesterdayStr
          );
          if (yesterdayEntry && yesterdayEntry[1] > 0) {
            streak = 1;

            // Check previous days
            let checkDate = new Date(yesterday);
            for (let i = 1; i <= sortedDates.length; i++) {
              checkDate.setDate(checkDate.getDate() - 1);
              const expectedDate = checkDate.toDateString();

              const found = sortedDates.find(([date]) => date === expectedDate);
              if (found && found[1] > 0) {
                streak++;
              } else {
                break;
              }
            }
          }
        }

        // Update display
        document.getElementById("summary7Day").innerText = avg7Day;
        document.getElementById("summaryBestDay").innerText = bestDay;
        document.getElementById("summaryActiveDays").innerText = activeDays;
        document.getElementById("summaryStreak").innerText = streak;
        document.getElementById("summaryMonthly").innerText = thisMonth;
      }

      function updateHistoryDetailed() {
        if (!currentCounter) return;

        const historyList = document.getElementById("historyList");
        const history = currentCounter.dailyHistory || {};

        // Clear existing content
        historyList.innerHTML = "";

        // Get all entries including today
        const today = new Date().toDateString();
        let entries = [];

        // Always include today if there's any activity
        if (dailyCount >= 0) {
          entries.push([today, dailyCount, true]); // true indicates today
        }

        // Add historical entries (exclude today to avoid duplication)
        Object.entries(history)
          .filter(([date, count]) => date !== today)
          .forEach(([date, count]) => {
            entries.push([date, count, false]);
          });

        // Apply filters
        entries = applyHistoryFilters(entries);

        // Apply sorting
        entries = applySorting(entries);

        if (entries.length === 0) {
          historyList.innerHTML = `
<div class="no-data">
<div class="no-data-icon">📿</div>
<div class="no-data-text">No history matches your filter</div>
<div class="no-data-subtext">Try adjusting your filter settings</div>
</div>
`;
          return;
        }

        entries.forEach(([date, count, isToday]) => {
          const rounds = Math.floor(count / japTarget);
          const historyItem = document.createElement("div");
          const isHighCount = count > 50;

          historyItem.className = `history-item ${
            isHighCount ? "high-count" : ""
          }`;

          historyItem.innerHTML = `
<div class="history-date">
<div class="date-main">${formatDateForDisplay(date)}</div>
<div class="date-sub">${getDayOfWeek(date)}</div>
</div>
<div class="history-stats">
<div class="history-count">
<div class="count-value">${count}</div>
<div class="count-label">Count</div>
</div>
<div class="history-count">
<div class="count-value">${rounds}</div>
<div class="count-label">Rounds</div>
</div>
</div>
<div class="history-actions">
${
  !isToday && count > 0
    ? `
<button class="action-btn edit-btn" onclick="editHistoryEntry('${date}', ${count})">✏️</button>
<button class="action-btn delete-btn" onclick="deleteHistoryEntry('${date}')">🗑️</button>
`
    : isToday
    ? '<span style="font-size: 12px; color: #ff4500;">Today</span>'
    : '<span style="font-size: 11px; color: #999;">No Activity</span>'
}
</div>
`;

          historyList.appendChild(historyItem);
        });
      }

      function applyHistoryFilters(entries) {
        const now = new Date();
        const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

        switch (currentFilter) {
          case "all":
            return entries.filter(
              ([date, count]) => count > 0 || date === now.toDateString()
            );
          case "high":
            return entries.filter(([date, count]) => count > 50);
          case "completed":
            return entries.filter(
              ([date, count]) => Math.floor(count / japTarget) > 0
            );
          case "recent":
            return entries.filter(([date, count]) => {
              const entryDate = new Date(date);
              return entryDate >= sevenDaysAgo;
            });
          case "month":
            return entries.filter(([date, count]) => {
              const entryDate = new Date(date);
              return entryDate >= monthStart;
            });
          default:
            return entries;
        }
      }

      function applySorting(entries) {
        return entries.sort(([dateA, countA], [dateB, countB]) => {
          if (currentSort === "date") {
            const comparison = new Date(dateB) - new Date(dateA);
            return isDescending ? comparison : -comparison;
          } else if (currentSort === "count") {
            const comparison = countB - countA;
            return isDescending ? comparison : -comparison;
          }
          return 0;
        });
      }

      function filterHistory(type) {
        currentFilter = type;

        // Update chip states
        document
          .querySelectorAll(".filter-chip")
          .forEach((chip) => chip.classList.remove("active"));
        event.target.classList.add("active");

        updateHistoryDetailed();
      }

      function editHistoryEntry(date, currentCount) {
        document.getElementById(
          "editHistoryDate"
        ).textContent = `Date: ${formatDateForDisplay(date)}`;
        document.getElementById("historyCountInput").value = currentCount;
        document.getElementById("editHistoryModal").style.display = "flex";

        // Store the date being edited
        window.editingHistoryDate = date;
      }

      function deleteHistoryEntry(date) {
        if (confirm(`Delete entry for ${formatDateForDisplay(date)}?`)) {
          if (currentCounter && currentCounter.dailyHistory) {
            const deletedCount = currentCounter.dailyHistory[date] || 0;
            delete currentCounter.dailyHistory[date];

            // Update lifetime count
            currentCounter.lifetimeCount = Math.max(
              0,
              currentCounter.lifetimeCount - deletedCount
            );
            lifetimeCount = currentCounter.lifetimeCount;

            saveCounterData();
            updateDisplay();
            updateHistoryDetailed();
            updateHistorySummary();
          }
        }
      }

      function toggleMenu() {
        const menu = document.getElementById("menuDropdown");
        menu.style.display = menu.style.display === "flex" ? "none" : "flex";
      }

      function closeMenu() {
        document.getElementById("menuDropdown").style.display = "none";
      }

      function toggleSwitch(el) {
        el.classList.toggle("active");
      }

      function toggleVibration(el) {
        el.classList.toggle("active");
        vibrationOn = el.classList.contains("active");

        const toggleText = el.querySelector(".toggle-text");
        if (toggleText) {
          toggleText.innerText = vibrationOn ? "ON" : "OFF";
        }
      }

      function initializeEditButton() {
        // Edit functionality removed - mantra always shows counter name
      }

      // ENHANCED THEME COLOR FUNCTIONS
      function loadThemeColor() {
        const savedColor = localStorage.getItem("themeColor");
        if (savedColor) {
          currentThemeColor = savedColor;
          applyThemeColor(currentThemeColor);
        }
      }

      function saveThemeColor(color) {
        localStorage.setItem("themeColor", color);
      }

      function toggleColorPicker() {
        const dropdown = document.getElementById("colorPickerDropdown");
        const isShowing = dropdown.classList.contains("show");

        if (isShowing) {
          // Hide with animation
          dropdown.classList.remove("show");
          setTimeout(() => {
            dropdown.style.display = "none";
          }, 300);
        } else {
          // Show with animation
          dropdown.style.display = "block";
          // Small delay to ensure display is set
          setTimeout(() => {
            dropdown.classList.add("show");
          }, 10);
        }
      }

      function selectThemeColor(color) {
        // Apply theme immediately for better responsiveness
        currentThemeColor = color;
        applyThemeColor(color);
        saveThemeColor(color);

        // Update the color circle
        document.getElementById("themeColorCircle").style.background = color;

        // Update selected color in picker
        document.querySelectorAll(".color-option").forEach((option) => {
          option.classList.remove("selected");
        });

        document
          .querySelector(`[data-color="${color}"]`)
          .classList.add("selected");

        // Show brief animation preview with new color
        showThemeChangeAnimation();

        // Close the picker
        const dropdown = document.getElementById("colorPickerDropdown");
        dropdown.classList.remove("show");
        setTimeout(() => {
          dropdown.style.display = "none";
        }, 300);
      }

      function showThemeChangeAnimation() {
        const animation = document.getElementById("openingAnimation");
        if (animation) {
          // Update content for theme change
          const title = animation.querySelector(".opening-title");
          const subtitle = animation.querySelector(".opening-subtitle");

          if (title) title.textContent = "Theme Updated";
          if (subtitle) subtitle.textContent = "New colors applied";

          // Reset all beads to visible for theme preview
          const beads = animation.querySelectorAll(".mala-bead");
          const tassel = animation.querySelector(".mala-tassel");

          beads.forEach((bead) => {
            bead.style.opacity = "1";
            bead.style.transform = "scale(1)";
          });

          if (tassel) {
            tassel.style.opacity = "1";
          }

          // Show animation briefly
          animation.style.display = "flex";
          animation.classList.remove("hide");

          setTimeout(() => {
            animation.classList.add("hide");
            setTimeout(() => {
              animation.style.display = "none";
              // Reset content
              if (title) title.textContent = "Jap Counter";
              if (subtitle)
                subtitle.textContent = "Spiritual Counting Companion";

              // Reset beads for next animation
              beads.forEach((bead) => {
                bead.style.opacity = "0";
                bead.style.transform = "scale(0)";
              });

              if (tassel) {
                tassel.style.opacity = "0";
              }
            }, 800);
          }, 2000);
        }
      }

      function applyThemeColor(color) {
        // Create CSS rule to override all orange colors
        const styleSheet = document.createElement("style");
        const colorRgba = hexToRgba(color, 0.3);
        styleSheet.innerHTML = `
/* Override all theme colors with selected color */
.logo-corner,
.logo-circle,
.menu-bar,
.create-btn,
.add-counter-btn,
.tap-btn,
.side-btn,
.btn,
.toggle.active,
.history-tab.active,
.filter-chip.active,
.stat-card {
background: ${color} !important;
}

/* Opening Animation Colors - Clean theme integration */
.mala-bead {
background: ${color} !important;
box-shadow: 0 4px 12px ${colorRgba}, 
            inset 0 2px 4px rgba(255, 255, 255, 0.5) !important;
}

.tassel-top {
background: ${color} !important;
box-shadow: 0 4px 12px ${colorRgba},
            inset 0 2px 4px rgba(255, 255, 255, 0.5) !important;
}

.tassel-middle {
background: ${color} !important;
}

.tassel-string {
background: linear-gradient(to bottom, ${color}, transparent) !important;
}

.loading-dot {
background: ${color} !important;
}

/* Fix borders for tap and side buttons */
.tap-btn {
border: 4px solid ${color} !important;
}

.side-btn {
border: 3px solid ${color} !important;
}

.logo-corner:hover,
.add-counter-btn:hover,
.tap-btn:hover,
.side-btn:hover,
.btn:hover {
background: ${adjustColorBrightness(color, -20)} !important;
}

.tap-btn:hover {
border-color: ${adjustColorBrightness(color, -20)} !important;
}

.side-btn:hover {
border-color: ${adjustColorBrightness(color, -20)} !important;
}

.tap-btn:active,
.side-btn:active,
.btn:active {
background: ${adjustColorBrightness(color, -40)} !important;
}

.tap-btn:active {
border-color: ${adjustColorBrightness(color, -40)} !important;
}

.side-btn:active {
border-color: ${adjustColorBrightness(color, -40)} !important;
}

.counter-card::before,
.welcome-box::before {
background: linear-gradient(90deg, ${color}, ${adjustColorBrightness(
          color,
          20
        )}) !important;
}

.create-btn,
.pro-btn,
.settings-modal,
.history-modal {
border-color: ${color} !important;
}

.stat-value,
.rounds-value,
.count-value,
.history-summary h3,
.summary-stat .value {
color: ${color} !important;
}

.btn {
box-shadow: 0 0 12px ${color}, 0 4px 8px rgba(0, 0, 0, 0.2) !important;
}

.btn:hover {
box-shadow: 0 0 18px ${adjustColorBrightness(
          color,
          -20
        )}, 0 6px 12px rgba(0, 0, 0, 0.25) !important;
}

.counter-name-input:focus {
border-color: ${color} !important;
box-shadow: 0 0 0 4px ${color}19 !important;
}

.scrollbar-thumb,
.counters-grid::-webkit-scrollbar-thumb {
background: ${color} !important;
}

.menu-dropdown button:hover {
background: ${color} !important;
}

.filter-chip:hover:not(.active) {
border-color: ${color} !important;
color: ${color} !important;
}

.history-item::before {
background: ${color} !important;
}

.settings-header,
.history-header {
background: ${color} !important;
}

.color-picker-dropdown {
border-color: ${color} !important;
}

`;

        // Remove old theme style if exists
        const oldStyle = document.getElementById("themeStyle");
        if (oldStyle) {
          oldStyle.remove();
        }

        styleSheet.id = "themeStyle";
        document.head.appendChild(styleSheet);
      }

      function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function adjustColorBrightness(color, percent) {
        // Convert hex to RGB
        const hex = color.replace("#", "");
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);

        // Adjust brightness
        const newR = Math.max(0, Math.min(255, r + (r * percent) / 100));
        const newG = Math.max(0, Math.min(255, g + (g * percent) / 100));
        const newB = Math.max(0, Math.min(255, b + (b * percent) / 100));

        // Convert back to hex
        return `#${Math.round(newR).toString(16).padStart(2, "0")}${Math.round(
          newG
        )
          .toString(16)
          .padStart(2, "0")}${Math.round(newB).toString(16).padStart(2, "0")}`;
      }

      // HOME EVENT LISTENERS
      document
        .getElementById("createCounterBtn")
        .addEventListener("click", function () {
          const nameInput = document.getElementById("counterNameInput");
          const name = nameInput.value.trim();

          if (name === "") {
            alert("Please enter a counter name");
            nameInput.focus();
            return;
          }

          if (
            counters.some((c) => c.name.toLowerCase() === name.toLowerCase())
          ) {
            alert("A counter with this name already exists");
            nameInput.focus();
            return;
          }

          const newCounter = createCounter(name);
          counters.push(newCounter);
          saveCounters();

          nameInput.value = "";
          showHomeScreen();
        });

      document
        .getElementById("counterNameInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            document.getElementById("createCounterBtn").click();
          }
        });

      document
        .getElementById("addCounterBtn")
        .addEventListener("click", function () {
          showWelcomeScreen();
        });

      // History edit modal event listeners
      document
        .getElementById("saveHistoryEdit")
        .addEventListener("click", function () {
          const newCount = parseInt(
            document.getElementById("historyCountInput").value
          );
          const date = window.editingHistoryDate;

          if (isNaN(newCount) || newCount < 0) {
            alert("Please enter a valid count (0 or greater)");
            return;
          }

          if (currentCounter && currentCounter.dailyHistory && date) {
            const oldCount = currentCounter.dailyHistory[date] || 0;
            const difference = newCount - oldCount;

            if (newCount === 0) {
              delete currentCounter.dailyHistory[date];
            } else {
              currentCounter.dailyHistory[date] = newCount;
            }

            // Update lifetime count
            currentCounter.lifetimeCount = Math.max(
              0,
              currentCounter.lifetimeCount + difference
            );
            lifetimeCount = currentCounter.lifetimeCount;

            saveCounterData();
            updateDisplay();
            updateHistoryDetailed();
            updateHistorySummary();
          }

          document.getElementById("editHistoryModal").style.display = "none";
        });

      document
        .getElementById("cancelHistoryEdit")
        .addEventListener("click", function () {
          document.getElementById("editHistoryModal").style.display = "none";
        });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (event) {
        const menu = document.getElementById("menuDropdown");
        const menuBar = document.querySelector(".menu-bar");

        if (menuBar && !menuBar.contains(event.target)) {
          menu.style.display = "none";
        }
      });

      // Close modals when clicking overlay
      document.getElementById("overlay").addEventListener("click", function () {
        closeSettings();
        closeHistory();
      });

      // Close color picker when clicking outside
      document.addEventListener("click", function (event) {
        const colorPicker = document.getElementById("colorPickerDropdown");
        const colorCircle = document.getElementById("themeColorCircle");

        if (
          colorPicker &&
          colorCircle &&
          !colorPicker.contains(event.target) &&
          !colorCircle.contains(event.target)
        ) {
          if (colorPicker.classList.contains("show")) {
            colorPicker.classList.remove("show");
            setTimeout(() => {
              colorPicker.style.display = "none";
            }, 300);
          }
        }
      });

      // Keyboard navigation for wallpaper lightbox
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          const lightbox = document.getElementById("wallpaperLightbox");
          if (lightbox && lightbox.classList.contains("active")) {
            lightbox.classList.remove("active");
            document.body.style.overflow = "auto";
            currentDeityForLightbox = null;
          }

          const modal = document.getElementById("wallpaperModal");
          if (modal && modal.classList.contains("show")) {
            closeWallpaperModal();
          }
        }

